<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>arduinoscope</title>
    <!-- this is a quick prototype of ideas. -->
    <!-- don't mind bloat, these can all be trimmed-down considerably, once required components are sorted out. -->
    <!-- also: IE pollyfills can be added later. This is only tested in Chrome 25.0.1364.36 beta, but should work fine in modern browsers -->
    <link href="http://jasny.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet">
    <link href="http://jasny.github.com/bootstrap/assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome.css" rel="stylesheet">
    <style>
    canvas {
      border: 1px solid #000;
    }
    span {
      color: green;
      font-size: 10px;
    }

    </style>
  </head>
  <body>
    <div id="topbar" class="navbar navbar-static-top navbar-inverse">
      <div class="navbar-inner">
        <a class="brand" href="#">arduinoscope</a>
      </div>
    </div>

    <div id="time"class="container"><span></span> KHz</div>
    <div id="scopes" class="container"></div>

  </body>
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // shim layer with setTimeout fallback
    // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
    window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       ||
              window.webkitRequestAnimationFrame ||
              window.mozRequestAnimationFrame    ||
              window.oRequestAnimationFrame      ||
              window.msRequestAnimationFrame     ||
              function( callback ){
                window.setTimeout(callback, 1000 / 60);
              };
    })();

    var socket = io.connect();
    $(function(){
      var hasCanvas = false;
      var values = [];
      var lastTime;
      socket.on('a', function(data){
        var now = (new Date()).getTime();

        $('#time span').html((now-lastTime));

        // first time, should have all pin-info
        if (!hasCanvas){
          hasCanvas = true;
          var t = '<label for="oscP">analog P <span id="valP"></span></label><canvas data-pin="P" id="oscP"></canvas>';
          data.forEach(function(p){
            $('#scopes').append(t.replace(/P/g, p.analogChannel));
          });
        }

        data.forEach(function(p){
          values[p.analogChannel] = values[p.analogChannel] || [];
          values[p.analogChannel].push(p.value);
          if (values[p.analogChannel].length >= 1000){
            values[p.analogChannel] = values[p.analogChannel].slice(-500);
          }
        });
      });

      function looper(){
        requestAnimFrame(looper);

        $('canvas').each(function(){
          var canvas = this;
          var context = canvas.getContext("2d");
          var pin = $(this).data('pin');
          lastTime = (new Date()).getTime();
          socket.emit('a', {pin:pin});

          canvas.width = $('#scopes').width();

          // draw cross
          context.strokeStyle = 'rgba(125, 125, 125, 0.5)';
          context.beginPath();
          context.moveTo(0, canvas.height / 2);
          context.lineTo(canvas.width, canvas.height / 2);
          context.moveTo(canvas.width / 2, 0);
          context.lineTo(canvas.width / 2, canvas.height);
          context.stroke();

          // draw wave
          context.strokeStyle = '#ff0000';
          context.beginPath();
          context.moveTo(0, canvas.height / 2);
          var unit = canvas.width/99;
          values[pin].slice(-500).forEach(function(d,i){
            context.lineTo(unit * i, canvas.height * (d/1024.0));
          });
          context.stroke();
          var v = values[pin].pop();

          $('#val' + pin).html((v/1024) * 5 + "V");
          values[pin].push(v);
        });
      }
      looper();

    });
  </script>
</html>
